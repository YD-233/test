import{_ as te}from"./index-88aec585.js";/* empty css                 *//* empty css                    *//* empty css               *//* empty css               *//* empty css                    *//* empty css                 */import{ax as V,r as y,aB as ae,e as le,d as ne,z as se,l as m,m as b,p as D,V as i,P as c,S as M,U as C,a9 as oe,T as x,O as re,az as ie,aA as ce}from"./vue-95bbca75.js";import{C as k}from"./index-926bd281.js";/* empty css                   */import{F as ue,o as de,C as pe,u as fe,a as g,b as P,y as he,B as ve,G as _e,t as ye}from"./element-61b2a7f7.js";const me=V("globalFileTree",{state:()=>({dict:{}}),actions:{addEntry(o,d){if(!Array.isArray(d))throw new Error("Value must be an array");this.dict[o]=d},updateEntry(o,d){if(!Array.isArray(d))throw new Error("Value must be an array");this.dict.hasOwnProperty(o)||(this.dict[o]=[]),this.dict[o]=d},getEntry(o){return this.dict[o]||[]},removeEntry(o){delete this.dict[o]}}}),ge=V("globalCurrentFileNode",{state:()=>({dict:{}}),actions:{setFileNode(o,d){d.trim()&&(this.dict[o]=d)},getFileNode(o){return this.dict[o]}}});const Fe=o=>(ie("data-v-69cfc197"),o=o(),ce(),o),be={class:"file-explorer"},Ce=["onDblclick"],ke=["onDblclick"],Ee={class:"file-details"},Te={key:0,class:"folder-content"},xe=Fe(()=>D("br",null,null,-1)),De=["onDblclick"],Ne={key:0},we={key:1},Be={key:1,class:"file-content"},Ie={__name:"ClientFiles",setup(o){const d=y([]),A=ae(),l=String(A.query.uid);y(!0);const r=y([]),u=y(null),h=y([]),w=y(null),E=y(""),n=y(null),T=me(),F=ge(),K={children:"children",label:"name"},$=async(t,e)=>{(await k.upload_file({uid:l,file:t.raw,uploadPath:e+"/"+t.name})).data.status===200&&g.success("后台上传中")},U=()=>!1,z=le(()=>{const t=e=>e.filter(a=>a.name!=="."&&a.name!=="..").map(a=>({...a,children:a.children?t(a.children):[]}));return t(r.value)}),B=async t=>{try{const e=await k.get_file_tree({uid:l,dirPath:t});e.data&&(r.value=e.data.data,T.updateEntry(l,r.value))}catch(e){console.error("Error fetching file tree:",e)}},R=async()=>{try{const t=await k.get_drives({uid:l});r.value=t.data.data,T.updateEntry(l,r.value)}catch(t){console.error("Error fetching file tree:",t)}},L=async t=>{await B(t);const e=v(t,r.value);e&&(u.value=e,h.value=e.children||[]),e&&n.value&&(F.setFileNode(l,e.path),n.value.setCurrentKey(e.path),n.value.store.nodesMap[e.path].expanded=!0)},O=async t=>{t.type==="D"?(u.value=t,h.value=t.children||[],w.value=null,E.value="",F.setFileNode(l,t.path)):t.type},G=async t=>{if(t.type==="D"){await B(t.path);const e=v(t.path,r.value);e&&(u.value=e,h.value=e.children||[]),e&&n.value&&(F.setFileNode(l,e.path),n.value.setCurrentKey(e.path),n.value.store.nodesMap[e.path].expanded=!0)}else t.type==="F"&&await S(t)},q=async t=>{await B(t.path);const e=v(t.path,r.value);e&&(u.value=e,h.value=e.children||[]),e&&n.value&&(F.setFileNode(l,e.path),n.value.setCurrentKey(e.path),n.value.store.nodesMap[e.path].expanded=!0)},j=async t=>{await S(t)},v=(t,e)=>{if(Array.isArray(e)){for(const a of e){const f=v(t,a);if(f)return f}return null}if(e.path===t)return e;if(e.children)for(const a of e.children){const f=v(t,a);if(f)return f}return null},S=async t=>{w.value=t;try{const e=await k.fetch_file_content({uid:l,path:t.path});E.value=e.data.content}catch(e){console.error("Error fetching file content:",e),E.value="Failed to load content."}},H=async t=>{try{const e=await k.delete_file({uid:l,filePath:t});r.value=e.data.data,T.updateEntry(l,r.value)}catch(e){console.error("Error fetching file tree:",e)}},J=async t=>{try{const e=await k.make_dir({uid:l,dirPath:t});r.value=e.data.data,T.updateEntry(l,r.value)}catch(e){console.error("Error fetching file tree:",e)}},Q=async t=>{const{value:e}=await P.prompt("请输入新文件夹的名称","新建文件夹",{confirmButtonText:"确定",cancelButtonText:"取消",inputPlaceholder:"文件夹名称"});if(!e){g.warning("文件夹名称不能为空");return}await J(t+"/"+e),g.success("新建成功");const a=v(t,r.value);a&&(u.value=a,h.value=a.children||[]),a&&n.value&&(F.setFileNode(l,a.path),n.value.setCurrentKey(a.path),n.value.store.nodesMap[a.path].expanded=!0)},W=t=>{const e=t.type==="F"?"文件":"文件夹";P.confirm(`是否删除${e}：${t.name}?`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{await H(t.path),g.success("删除"+t.name+"成功");let a="",f=t.path.lastIndexOf("/");f!==-1&&(a=t.path.substring(0,f));const p=v(a,r.value);p&&(u.value=p,h.value=p.children||[]),p&&n.value&&(F.setFileNode(l,p.path),n.value.setCurrentKey(p.path),n.value.store.nodesMap[p.path].expanded=!0)})},X=t=>{P.confirm(`是否下载文件：${t.name}?`,"下载确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async({value:e})=>{try{(await k.download_file({uid:l,filePath:t.path})).data.status===200?g.success("后台下载"+t.path+"中"):g.error("下载"+t.path+"失败")}catch{g.error("下载"+t.path+"失败")}}).catch(()=>{g.info("已取消下载")})};return ne(()=>{const t=T.getEntry(l);if(Array.isArray(t)&&t.length===0)B("./");else{r.value=T.getEntry(l);const e=F.getFileNode(l),a=v(e,r.value);a&&(u.value=a,h.value=a.children||[]),setTimeout(()=>{a&&n.value&&(n.value.setCurrentKey(a.path),n.value.store.nodesMap[a.path].expanded=!0)},100)}}),se(()=>{r.value=[],u.value=null,h.value=[],w.value=null,E.value=""}),(t,e)=>{const a=ue,f=he,p=ve,N=de,Y=_e,Z=pe,I=ye,ee=fe;return m(),b("div",null,[D("div",be,[i(a,{ref_key:"fileTreeRef",ref:n,data:z.value,props:K,"node-key":"path",onNodeClick:O,"highlight-current":""},{default:c(({node:s,data:_})=>[_.type==="D"?(m(),b("span",{key:0,onDblclick:()=>q(_)},"📁 "+C(_.name),41,Ce)):(m(),b("span",{key:1,onDblclick:()=>j(_)},"📄 "+C(_.name),41,ke))]),_:1},8,["data"]),D("div",Ee,[u.value?(m(),b("div",Te,[i(Z,{gutter:10},{default:c(()=>[i(p,{span:18},{default:c(()=>[i(f,{modelValue:u.value.path,"onUpdate:modelValue":e[0]||(e[0]=s=>u.value.path=s),onKeyup:e[1]||(e[1]=oe(s=>L(u.value.path),["enter"]))},null,8,["modelValue"])]),_:1}),i(p,{span:3},{default:c(()=>[i(Y,{"file-list":d.value,"onUpdate:fileList":e[2]||(e[2]=s=>d.value=s),limit:1,ref:"uploadRef",class:"upload",action:"","on-change":s=>$(s,u.value.path),"before-upload":U},{trigger:c(()=>[i(N,{type:"success"},{default:c(()=>[x("上传文件")]),_:1})]),_:1},8,["file-list","on-change"])]),_:1}),i(p,{span:3},{default:c(()=>[i(N,{type:"primary",onClick:e[3]||(e[3]=s=>Q(u.value.path))},{default:c(()=>[x("新建文件夹")]),_:1})]),_:1})]),_:1}),xe,i(ee,{data:h.value,style:{width:"100%"}},{default:c(()=>[i(I,{prop:"name",label:"文件名",sortable:""},{default:c(({row:s})=>[D("span",{onDblclick:_=>G(s),style:{cursor:"pointer"}},[s.type==="D"?(m(),b("span",Ne,"📁 "+C(s.name),1)):(m(),b("span",we,"📄 "+C(s.name),1))],40,De)]),_:1}),i(I,{prop:"size",label:"大小",sortable:""},{default:c(({row:s})=>[x(C(s.size),1)]),_:1}),i(I,{prop:"modifiedTime",label:"修改时间",sortable:""}),i(I,{prop:"action",label:"操作"},{default:c(({row:s})=>[s.type==="F"?(m(),re(N,{key:0,onClick:_=>X(s),type:"primary",size:"small"},{default:c(()=>[x("下载")]),_:2},1032,["onClick"])):M("",!0),i(N,{onClick:_=>W(s),type:"danger",size:"small"},{default:c(()=>[x("删除")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])])):M("",!0),E.value?(m(),b("div",Be,[D("h3",null,C(w.value.path),1),D("pre",null,C(E.value),1)])):M("",!0)])]),i(N,{type:"success",onClick:R},{default:c(()=>[x("Drives")]),_:1})])}}},Oe=te(Ie,[["__scopeId","data-v-69cfc197"]]);export{Oe as default};
